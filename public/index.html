<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Chess Club</title>

  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/svg+xml" href="/chess-pawn.svg">
	<link rel="icon" type="image/png" href="/favicon.png">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&display=swap" rel="stylesheet">
</head>

<body>
  <div class="container">

    <div class="no-print">
      <!--<h1><span class="white-pawn">♙</span> Chess Club</h1>!-->
	  <h1 class="title">
	  <img class="pawn-icon" src="/chess-pawn.svg" alt="Chess pawn" />
	  Chess Club
	</h1>
      <p class="subhead">Add players, generate schedules, filter by Thursdays, and print.</p>

      <div class="card">
        <h2>Add Player</h2>
        <hr />
        <form id="playerForm" class="row">
          <input type="text" id="name" placeholder="Player Name" required />
          <select id="level">
            <option value="1">Level 1</option>
            <option value="2">Level 2</option>
            <option value="3">Level 3</option>
          </select>
          <button type="submit" class="admin-btn">Add Player</button>
        </form>
      </div>

      <div style="height:14px;"></div>

      <div class="card">
        <div class="row" style="justify-content: space-between;">
          <h2 style="margin:0;">Schedules</h2>
          <button class="admin-btn btn-primary" type="button" id="btnGenerate">
            Generate &amp; Save Schedule
          </button>
        </div>

        <hr />

        <ul id="scheduleList"></ul>

        <div style="margin: 12px 0;" class="row">
          <label>
            Show matches on:
            <input type="date" id="filterDate" />
          </label>

          <button class="admin-btn" type="button" id="btnFilter">Filter</button>
          <button class="admin-btn" type="button" id="btnClearFilter">Clear</button>
        </div>
      </div>
    </div><!-- /.no-print -->

    <!-- PRINT AREA -->
    <div id="printArea" class="card">
      <h2 id="printTitle">Schedule</h2>
      <hr />
      <div id="printMeta"></div>

      <div class="table-wrap">
        <table id="printTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Level</th>
              <th>Player</th>
              <th>Opponent</th>
              <th class="no-print">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Status + Save/Print -->
      <div class="no-print row" style="margin-top:12px; justify-content: space-between;">
        <div id="scheduleStatus" style="color: rgba(233,238,252,0.75); font-size: 0.95rem;">
          Saved
        </div>

        <div class="row" style="gap:10px;">
          <button class="admin-btn" type="button" id="btnPrint">Print</button>
          <button id="btnSaveSchedule" class="admin-btn btn-primary" type="button" disabled>
            Save Schedule
          </button>
        </div>
      </div>
    </div>

    <div style="height:14px;"></div>

    <div class="no-print card">
      <h2>Player List</h2>
      <hr />
      <div class="table-wrap">
        <table id="playerTable">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Name</th>
              <th>Level</th>
              <th>Score</th>
              <th class="no-print">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Modal Backdrop -->
    <div id="modalBackdrop" class="modal-backdrop hidden" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-header">
          <h3 id="modalTitle">Edit</h3>
          <button id="modalClose" class="admin-btn" type="button">✕</button>
        </div>

        <form id="modalForm">
          <div id="modalBody" class="modal-body"></div>

          <div class="modal-actions">
            <button type="button" id="modalCancel" class="admin-btn">Cancel</button>
            <button type="submit" class="admin-btn btn-primary">Save</button>
          </div>
        </form>
      </div>
    </div>

    <footer class="no-print app-footer">
      <p>Built by <strong>Josh Schwartzkopf</strong> © 2026</p>
    </footer>

  </div><!-- /.container -->

  <script>
  // ---------- Global state ----------
  let currentSchedule = null;
  let allPlayers = [];
  let scheduleDirty = false;

  // ---------- DOM refs ----------
  const form = document.getElementById("playerForm");
  const scheduleList = document.getElementById("scheduleList");

  const btnGenerate = document.getElementById("btnGenerate");
  const btnFilter = document.getElementById("btnFilter");
  const btnClearFilter = document.getElementById("btnClearFilter");
  const btnPrint = document.getElementById("btnPrint");
  const btnSaveSchedule = document.getElementById("btnSaveSchedule");

  // Modal refs
  const modalBackdrop = document.getElementById("modalBackdrop");
  const modalTitle = document.getElementById("modalTitle");
  const modalBody = document.getElementById("modalBody");
  const modalForm = document.getElementById("modalForm");
  const modalClose = document.getElementById("modalClose");
  const modalCancel = document.getElementById("modalCancel");

  let modalOnSubmit = null;

  // ---------- Helpers ----------
  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function formatScore(v) {
    const n = Number(v ?? 0);
    return Number.isInteger(n) ? String(n) : String(n).replace(/0+$/, "").replace(/\.$/, "");
  }

  function hasMatchInfo(m) {
    return (m.notes && String(m.notes).trim()) || m.result || (m.status && m.status !== "scheduled");
  }

  async function fetchJson(url, options) {
    const res = await fetch(url, options);
    if (!res.ok) {
      const txt = await res.text();
      throw new Error(`${options?.method || "GET"} ${url} failed: ${res.status} ${txt}`);
    }
    return res.json();
  }

  function setScheduleDirty(isDirty) {
    scheduleDirty = isDirty;

    const status = document.getElementById("scheduleStatus");
    if (btnSaveSchedule) btnSaveSchedule.disabled = !isDirty;

    if (status) {
      status.textContent = isDirty ? "Unsaved changes" : "Saved";
      status.style.color = isDirty ? "#22c55e" : "rgba(233,238,252,0.75)";
    }
  }

  // ---------- Modal helpers ----------
  function openModal({ title, bodyHtml, onSubmit }) {
    modalTitle.textContent = title;
    modalBody.innerHTML = bodyHtml;
    modalOnSubmit = onSubmit;

    modalBackdrop.classList.remove("hidden");
    modalBackdrop.setAttribute("aria-hidden", "false");

    const first = modalBody.querySelector("input, select, textarea, button");
    if (first) first.focus();
  }

  function closeModal() {
    modalBackdrop.classList.add("hidden");
    modalBackdrop.setAttribute("aria-hidden", "true");
    modalBody.innerHTML = "";
    modalOnSubmit = null;
  }

  modalClose?.addEventListener("click", closeModal);
  modalCancel?.addEventListener("click", closeModal);

  modalBackdrop?.addEventListener("click", (e) => {
    if (e.target === modalBackdrop) closeModal();
  });

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && modalBackdrop && !modalBackdrop.classList.contains("hidden")) {
      closeModal();
    }
  });

  modalForm?.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (typeof modalOnSubmit === "function") {
      await modalOnSubmit(new FormData(modalForm));
    }
  });

  // ---------- Players ----------
  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const name = document.getElementById("name").value.trim();
    const level = document.getElementById("level").value;

    try {
      const players = await fetchJson("/add-player", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, level })
      });

      allPlayers = players;
      renderPlayers(players);
      form.reset();
    } catch (err) {
      console.error(err);
      alert("Add player failed. Check console/logs.");
    }
  });

  async function loadPlayers() {
    try {
      const players = await fetchJson("/players");
      allPlayers = Array.isArray(players) ? players : [];
      renderPlayers(allPlayers);
    } catch (err) {
      console.error(err);
      renderPlayers([]);
    }
  }

  function renderPlayers(players) {
    const tbody = document.querySelector("#playerTable tbody");
    if (!tbody) return;

    tbody.innerHTML = "";

    const sorted = [...(players || [])].sort((a, b) => (b.score ?? 0) - (a.score ?? 0));

    sorted.forEach((p, index) => {
      const tr = document.createElement("tr");

      const tdRank = document.createElement("td");
      tdRank.textContent = index + 1;

      const tdName = document.createElement("td");
      tdName.textContent = p.name;

      const tdLevel = document.createElement("td");
      tdLevel.textContent = p.level;

      const tdScore = document.createElement("td");
      tdScore.textContent = formatScore(p.score);

      const tdActions = document.createElement("td");
      tdActions.className = "no-print";

      const editBtn = document.createElement("button");
      editBtn.textContent = "Edit";
      editBtn.className = "admin-btn";
      editBtn.addEventListener("click", () => editPlayer(p.id, p.name, p.level, p.score ?? 0));

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "Delete";
      deleteBtn.className = "admin-btn btn-danger";
      deleteBtn.addEventListener("click", () => deletePlayer(p.id, deleteBtn));

      tdActions.appendChild(editBtn);
      tdActions.appendChild(deleteBtn);

      tr.appendChild(tdRank);
      tr.appendChild(tdName);
      tr.appendChild(tdLevel);
      tr.appendChild(tdScore);
      tr.appendChild(tdActions);

      tbody.appendChild(tr);
    });
  }

  async function deletePlayer(id, btn) {
    try {
      if (btn) {
        btn.disabled = true;
        btn.textContent = "Deleting…";
      }
      await fetchJson(`/players/${id}`, { method: "DELETE" });
      await loadPlayers();
    } catch (err) {
      console.error(err);
      alert("Delete failed. Player may be involved in a scheduled match.  Check console.");
    } finally {
      if (btn) {
        btn.disabled = false;
        btn.textContent = "Delete";
      }
    }
  }

  function editPlayer(id, currentName, currentLevel, currentScore) {
    openModal({
      title: "Edit Player",
      bodyHtml: `
        <div class="field">
          <label for="mp_name">Name</label>
          <input id="mp_name" name="name" type="text" value="${escapeHtml(currentName)}" required />
        </div>

        <div class="field">
          <label for="mp_level">Level</label>
          <select id="mp_level" name="level">
            <option value="1" ${String(currentLevel) === "1" ? "selected" : ""}>Level 1</option>
            <option value="2" ${String(currentLevel) === "2" ? "selected" : ""}>Level 2</option>
            <option value="3" ${String(currentLevel) === "3" ? "selected" : ""}>Level 3</option>
          </select>
        </div>

        <div class="field">
          <label for="mp_score">Score</label>
          <input id="mp_score" name="score" type="number" step="0.5" value="${escapeHtml(currentScore ?? 0)}" />
        </div>
      `,
      onSubmit: async (fd) => {
        const name = fd.get("name").toString().trim();
        const level = fd.get("level").toString();
        const score = fd.get("score").toString();

        try {
          await fetchJson(`/players/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, level, score })
          });

          closeModal();
          await loadPlayers();
        } catch (err) {
          console.error(err);
          alert("Save player failed. Check console.");
        }
      }
    });
  }

  function getPlayerNamesByLevel(level) {
    return allPlayers
      .filter(p => Number(p.level) === Number(level))
      .map(p => p.name)
      .sort((a, b) => a.localeCompare(b));
  }

  function buildOptions(names, selected) {
    return names.map(n =>
      `<option value="${escapeHtml(n)}" ${n === selected ? "selected" : ""}>${escapeHtml(n)}</option>`
    ).join("");
  }

  // ---------- Schedules ----------
  btnGenerate?.addEventListener("click", generateSchedule);
  btnFilter?.addEventListener("click", applyDateFilter);
  btnClearFilter?.addEventListener("click", clearDateFilter);
  btnPrint?.addEventListener("click", () => window.print());
  btnSaveSchedule?.addEventListener("click", saveSchedule);

  async function generateSchedule() {
    try {
      const newSchedule = await fetchJson("/schedule", { method: "POST" });
      renderSchedule(newSchedule);
      await loadSchedules();
    } catch (err) {
      console.error(err);
      alert("Generate schedule failed. Check console/logs.");
    }
  }

  async function loadSchedules() {
    try {
      const schedules = await fetchJson("/schedules");
      const list = Array.isArray(schedules) ? schedules : [];

      scheduleList.innerHTML = "";

      list.forEach((s) => {
        const li = document.createElement("li");
        li.textContent = `Schedule ${s.createdAt} `;

        const viewBtn = document.createElement("button");
        viewBtn.textContent = "View";
        viewBtn.className = "admin-btn";
        viewBtn.addEventListener("click", () => viewSchedule(s.id));

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Delete";
        deleteBtn.className = "admin-btn btn-danger";
        deleteBtn.addEventListener("click", () => deleteSchedule(s.id, deleteBtn));

        li.appendChild(viewBtn);
        li.appendChild(deleteBtn);
        scheduleList.appendChild(li);
      });

      if (list.length > 0) {
        await viewSchedule(list[list.length - 1].id);
      } else {
        clearScheduleDisplay();
      }
    } catch (err) {
      console.error(err);
      clearScheduleDisplay();
    }
  }

  async function viewSchedule(id) {
    if (scheduleDirty && !confirm("You have unsaved changes. Switch schedules anyway?")) return;

    try {
      const schedule = await fetchJson(`/schedules/${id}`);
      renderSchedule(schedule);
      document.getElementById("printArea")?.scrollIntoView({ behavior: "smooth" });
    } catch (err) {
      console.error(err);
      alert("View schedule failed. Check console/logs.");
    }
  }

  async function deleteSchedule(id, btn) {
    try {
      if (btn) {
        btn.disabled = true;
        btn.textContent = "Deleting…";
      }
      await fetchJson(`/schedules/${id}`, { method: "DELETE" });
      await loadSchedules();
    } catch (err) {
      console.error(err);
      alert("Delete schedule failed. Check console/logs.");
    } finally {
      if (btn) {
        btn.disabled = false;
        btn.textContent = "Delete";
      }
    }
  }

  function renderSchedule(schedule) {
    currentSchedule = schedule;

    document.getElementById("printTitle").textContent = "Round Robin Schedule";
    document.getElementById("printMeta").textContent =
      `Created: ${schedule.createdAt} | Matches: ${schedule.matches.length}`;

    renderMatches(schedule.matches);
    setScheduleDirty(false);
  }

  function renderMatches(matches) {
    const tbody = document.querySelector("#printTable tbody");
    if (!tbody) return;

    tbody.innerHTML = "";

    (matches || []).forEach((m) => {
      const tr = document.createElement("tr");

      const tdDate = document.createElement("td");
      tdDate.textContent = m.date;

      const tdLevel = document.createElement("td");
      tdLevel.textContent = `Level ${m.level}`;

      const tdPlayer = document.createElement("td");
      tdPlayer.textContent = m.player1;

      const tdOpponent = document.createElement("td");
      tdOpponent.textContent = m.player2;

      const tdActions = document.createElement("td");
      tdActions.className = "no-print";

      // Info indicator if notes/result/status set
      if (hasMatchInfo(m)) {
        const info = document.createElement("span");
        info.textContent = "ℹ️";
        info.title = "This match has notes/result/status updates";
        info.style.marginRight = "8px";
        tdActions.appendChild(info);
      }

      const editBtn = document.createElement("button");
      editBtn.textContent = "Edit";
      editBtn.className = "admin-btn";
      editBtn.addEventListener("click", () => editMatch(m));

      tdActions.appendChild(editBtn);

      tr.appendChild(tdDate);
      tr.appendChild(tdLevel);
      tr.appendChild(tdPlayer);
      tr.appendChild(tdOpponent);
      tr.appendChild(tdActions);

      tbody.appendChild(tr);
    });
  }

  // ---------- Filter by date ----------
  function applyDateFilter() {
    if (!currentSchedule) return;

    const selected = document.getElementById("filterDate").value;
    if (!selected) return;

    const filtered = (currentSchedule.matches || []).filter(m => m.date === selected);

    document.getElementById("printMeta").textContent =
      `Matches on ${selected} | Count: ${filtered.length}`;

    renderMatches(filtered);
  }

  function clearDateFilter() {
    if (!currentSchedule) return;

    document.getElementById("filterDate").value = "";
    document.getElementById("printMeta").textContent =
      `Created: ${currentSchedule.createdAt} | Matches: ${currentSchedule.matches.length}`;

    renderMatches(currentSchedule.matches);
  }

  // ---------- Edit match (draft-only) ----------
  function editMatch(m) {
    if (!currentSchedule) return;

    if (!m.matchId) {
      alert("This schedule/match is missing matchId. Generate a new schedule.");
      return;
    }

    const names = getPlayerNamesByLevel(m.level);

    openModal({
      title: "Edit Match",
      bodyHtml: `
        <div class="field">
          <label for="mm_date">Date</label>
          <input id="mm_date" name="date" type="date" value="${escapeHtml(m.date)}" required />
        </div>

        <div class="field">
          <label for="mm_player1">Player</label>
          <select id="mm_player1" name="player1">
            ${buildOptions(names, m.player1)}
          </select>
        </div>

        <div class="field">
          <label for="mm_player2">Opponent</label>
          <select id="mm_player2" name="player2">
            ${buildOptions(names, m.player2)}
          </select>
        </div>

        <div class="field">
          <label for="mm_status">Status</label>
          <select id="mm_status" name="status">
            ${["scheduled", "completed", "forfeit", "canceled"].map(s =>
              `<option value="${s}" ${m.status === s ? "selected" : ""}>${s}</option>`
            ).join("")}
          </select>
        </div>

        <div class="field">
          <label for="mm_result">Result (optional)</label>
          <input id="mm_result" name="result" type="text"
            placeholder="e.g. 1-0, 0-1, 0.5-0.5"
            value="${escapeHtml(m.result ?? "")}" />
        </div>

        <div class="field">
          <label for="mm_notes">Notes (optional)</label>
          <textarea id="mm_notes" name="notes">${escapeHtml(m.notes ?? "")}</textarea>
        </div>
      `,
      onSubmit: async (fd) => {
        const date = fd.get("date").toString();
        const player1 = fd.get("player1").toString();
        const player2 = fd.get("player2").toString();
        const status = fd.get("status").toString();
        const result = fd.get("result").toString().trim() || null;
        const notes = fd.get("notes").toString().trim() || "";

        if (player1 === player2) {
          alert("Player and Opponent cannot be the same.");
          return;
        }

        const idx = (currentSchedule.matches || []).findIndex(x => x.matchId === m.matchId);
        if (idx === -1) {
          alert("Match not found in current schedule.");
          return;
        }

        currentSchedule.matches[idx] = {
          ...currentSchedule.matches[idx],
          date,
          player1,
          player2,
          status,
          result,
          notes
        };

        closeModal();
        renderSchedule(currentSchedule);
        setScheduleDirty(true);
      }
    });
  }

  // ---------- Save schedule ----------
  async function saveSchedule() {
    if (!currentSchedule?.id) return;

    try {
      const saved = await fetchJson(`/schedules/${currentSchedule.id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(currentSchedule)
      });

      currentSchedule = saved;
      renderSchedule(saved);
      setScheduleDirty(false);
      await loadSchedules();
    } catch (err) {
      console.error(err);
      alert("Save schedule failed. Check console/logs.");
    }
  }

  function clearScheduleDisplay() {
    document.getElementById("printTitle").textContent = "Schedule";
    document.getElementById("printMeta").textContent = "No saved schedules yet.";
    document.querySelector("#printTable tbody").innerHTML = "";
    setScheduleDirty(false);
  }

  // ---------- Init ----------
  document.addEventListener("DOMContentLoaded", () => {
    loadPlayers();
    loadSchedules();
  });
</script>
</body>
</html>